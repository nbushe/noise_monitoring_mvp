#!/bin/bash
sudo apt update

# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo apt install -y python3 python3-pip
pip install -r backend/requirements.txt

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ root (–∏–ª–∏ sudo)
if [ "$EUID" -ne 0 ]; then
  echo "‚ö†Ô∏è  –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ sudo. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å sudo..."
  exec sudo bash "$0" "$@"
  exit
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –¥–ª—è Docker
DNS_CONFIG='{"dns": ["8.8.8.8", "8.8.4.4"]}'

echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –≤ Docker: $DNS_CONFIG"
echo "$DNS_CONFIG" > /etc/docker/daemon.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker..."
systemctl restart docker

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ Docker –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
systemctl enable docker 2>/dev/null || echo "‚ö†Ô∏è  Docker —É–∂–µ –≤–∫–ª—é—á—ë–Ω –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É"

# –¢–µ—Å—Ç DNS –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º DNS –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
if docker run --rm python:3.10-slim nslookup pypi.org > /dev/null 2>&1; then
  echo "‚úÖ DNS —Ä–∞–±–æ—Ç–∞–µ—Ç! –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç —Ä–∞–∑—Ä–µ—à–∞—Ç—å –¥–æ–º–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞."
else
  echo "‚ùå –¢–µ—Å—Ç DNS –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å."
  exit 1
fi



docker login

